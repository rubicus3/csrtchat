<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мессенджер</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        /* Стиль для адаптивного макета во весь экран */
        body { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .main-container { flex: 1; display: flex; overflow: hidden; }

        /* Боковая панель (список чатов) */
        .sidebar { width: 300px; border-right: 1px solid #dee2e6; overflow-y: hidden; background: #f8f9fa; display: flex; flex-direction: column; }
        .chat-list-container { flex: 1; overflow-y: auto; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #dee2e6; }

        .chat-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 3px solid transparent; /* Для выделения активности/нового сообщения */
        }
        .chat-item:hover { background-color: #e2e6ea; }
        .chat-item.active {
            background-color: #0d6efd;
            color: white;
            border-left: 3px solid #0056b3; /* Синяя полоса для активного чата */
        }
        .chat-item.active .text-muted { color: rgba(255, 255, 255, 0.8) !important; }

        /* Индикатор нового сообщения */
        .chat-item.border-warning {
            border-left: 3px solid #ffc107;
            font-weight: bold;
        }

        /* Область чата */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-area { padding: 15px; border-top: 1px solid #dee2e6; background: white; }

        /* Стиль сообщений */
        .message {
            padding: 8px 12px;
            border-radius: 15px;
            min-width: 15%;
            max-width: 70%;
            line-height: 1.3;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        .message.mine {
            background-color: #0d6efd;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .message.theirs {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 0;
            margin-right: auto;
        }
        .message-sender { font-size: 0.8em; font-weight: bold; margin-bottom: 3px; }
        .message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
            line-height: 1;
        }
        .edited-label {
            font-size: 0.7em;
            font-style: italic;
            margin-left: 5px;
            opacity: 0.8;
        }
        .message.mine .message-time { color: rgba(255, 255, 255, 0.8); }
        .user-search-item { cursor: pointer; transition: background-color 0.1s; }
        .user-search-item:hover { background-color: #f1f1f1; }

        /* Кнопки управления (удалить/редактировать) */
        .message-actions {
            position: absolute;
            top: -10px;
            right: -5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            background: white;
            color: #333;
        }

        .action-btn.delete { background: #dc3545; color: white; }
        .action-btn.edit { background: #ffc107; color: black; }

        .action-btn:hover { transform: scale(1.1); }
        .action-btn.delete:hover { background: #bb2d3b; }
        .action-btn.edit:hover { background: #e0a800; }

    </style>
</head>
<body>

<!-- Навигация -->
<nav class="navbar navbar-light bg-light border-bottom px-3">
    <span class="navbar-brand mb-0 h1">Messenger</span>
    <div class="d-flex align-items-center">
        <span class="me-3 text-muted">Пользователь: {{ user.username }}</span>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm">Выход</a>
    </div>
</nav>

<div class="main-container">
    <!-- Список чатов (Сайдбар) -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#newChatModal">
                Новый чат
            </button>
        </div>
        <div class="chat-list-container list-group list-group-flush" id="chat-list">
            {% for convo in conversations %}
            <div id="convo-{{ convo.conversation_id }}"
                 class="chat-item"
                 onclick="selectChat({{ convo.conversation_id }}, this)">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        {% if convo.type.value == 'group' and convo.name %}
                            {{ convo.name }} (Группа)
                        {% elif convo.type.value == 'private' %}
                            Чат #{{ convo.conversation_id }}
                        {% endif %}
                    </h6>
                    <small class="text-muted">{{ convo.updated_at.strftime('%H:%M') }}</small>
                </div>
                <p class="mb-1 small text-muted text-truncate">Начните общение...</p>
            </div>
            {% else %}
            <div class="p-3 text-muted">Нет активных чатов. Начните новый!</div>
            {% endfor %}
        </div>
    </div>

    <!-- Область сообщений -->
    <div class="chat-area">
        <div id="messages" class="messages-box">
            <div class="text-center mt-5 text-muted">Выберите чат слева или начните новый.</div>
        </div>

        <div class="input-area" id="input-area" style="display:none;">
            <!-- Индикатор режима редактирования -->
            <div id="edit-indicator" class="mb-2 text-warning small" style="display:none;">
                Редактирование сообщения...
                <a href="#" onclick="cancelEditing(event)" class="text-secondary ms-2">Отмена</a>
            </div>
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="Напишите сообщение..." autofocus>
                <button class="btn btn-primary" id="send-btn" onclick="sendMessage()">Отправить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания нового чата -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChatModalLabel">Начать новый чат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="user-search-input"
                           placeholder="Введите имя пользователя..." onkeyup="searchUsers()">
                </div>
                <div id="user-search-results" class="list-group">
                    <!-- Результаты поиска будут здесь -->
                </div>

                <div class="mt-4 p-3 border rounded" id="selected-user-info" style="display:none;">
                    <p class="mb-1">Выбран пользователь:</p>
                    <strong id="selected-username"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" id="create-chat-btn" onclick="createNewPrivateChat()" disabled>
                    Создать чат
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты Bootstrap и SocketIO -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    let currentConversationId = null;
    let editingMessageId = null; // ID сообщения, которое редактируется

    const currentUserId = {{ user.user_id }};
    const messagesBox = document.getElementById('messages');
    const inputArea = document.getElementById('input-area');
    const messageInput = document.getElementById('message-input');
    const chatList = document.getElementById('chat-list');
    const editIndicator = document.getElementById('edit-indicator');
    const sendBtn = document.getElementById('send-btn');

    // Переменная для хранения ID пользователя, с которым хотим начать чат
    let targetUserId = null;
    let targetUsername = '';

    const newChatModalElement = document.getElementById('newChatModal');
    const newChatModal = new bootstrap.Modal(newChatModalElement);

    newChatModalElement.addEventListener('hidden.bs.modal', function () {
        document.getElementById('user-search-input').value = '';
        document.getElementById('user-search-results').innerHTML = '';
        document.getElementById('selected-user-info').style.display = 'none';
        document.getElementById('create-chat-btn').disabled = true;
        targetUserId = null;
    });

    // --- SOCKETIO ЛОГИКА ---

    socket.on('connect', () => {
        console.log('Connected to WebSocket');
    });

    socket.on('new_message', (data) => {
        if (currentConversationId === data.conversation_id) {
            appendMessage(data);
        }
        const convoElement = document.getElementById(`convo-${data.conversation_id}`);
        if (convoElement) {
            chatList.prepend(convoElement);
            if (currentConversationId !== data.conversation_id) {
                convoElement.classList.add('border-warning');
            }
        }
    });

    socket.on('message_updated', (data) => {
        // Находим сообщение в DOM и обновляем текст
        const msgDiv = document.getElementById(`msg-${data.message_id}`);
        if (msgDiv) {
            const contentSpan = msgDiv.querySelector('.message-content');
            if (contentSpan) contentSpan.textContent = data.content;

            // Добавляем пометку (изменено), если её нет
            if (!msgDiv.querySelector('.edited-label')) {
                const timeSpan = msgDiv.querySelector('.message-time');
                const editedLabel = document.createElement('span');
                editedLabel.className = 'edited-label';
                editedLabel.textContent = '(изменено)';

                // Вставляем перед временем
                if (timeSpan) {
                    timeSpan.parentNode.insertBefore(editedLabel, timeSpan);
                } else {
                    msgDiv.appendChild(editedLabel);
                }
            }
        }
    });

    socket.on('message_deleted', (data) => {
        const msgDiv = document.getElementById(`msg-${data.message_id}`);
        if (msgDiv) {
            msgDiv.remove();
        }
    });

    // --- UI FUNCTIONS ---

    function selectChat(chatId, element) {
        cancelEditing(); // Сброс режима редактирования при смене чата

        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active', 'border-warning'));
        element.classList.add('active');
        element.classList.remove('border-warning');

        if (currentConversationId) {
            socket.emit('leave', { conversation_id: currentConversationId });
        }

        currentConversationId = chatId;
        inputArea.style.display = 'block';
        messagesBox.innerHTML = '<div class="text-center mt-5 text-muted">Загрузка истории...</div>';

        fetch(`/api/messages/${chatId}`)
            .then(response => response.json())
            .then(messages => {
                messagesBox.innerHTML = '';
                if (messages.length === 0) {
                    messagesBox.innerHTML = '<div class="text-center mt-5 text-muted">Начните переписку.</div>';
                } else {
                    messages.forEach(msg => appendMessage(msg));
                }
                messagesBox.scrollTop = messagesBox.scrollHeight;
                socket.emit('join', { conversation_id: chatId });
                messageInput.focus();
            })
            .catch(error => {
                console.error("Fetch error:", error);
                inputArea.style.display = 'none';
            });
    }

    function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentConversationId) return;

        if (editingMessageId) {
            // РЕЖИМ РЕДАКТИРОВАНИЯ
            socket.emit('edit_message', {
                message_id: editingMessageId,
                conversation_id: currentConversationId,
                new_content: text
            });
            cancelEditing(); // Выход из режима редактирования
        } else {
            // ОБЫЧНАЯ ОТПРАВКА
            socket.emit('send_message', {
                conversation_id: currentConversationId,
                message: text
            });
            messageInput.value = '';
        }
        messageInput.focus();
    }

    // Включение режима редактирования
    function startEditing(id, currentContent) {
        editingMessageId = id;
        messageInput.value = currentContent;
        messageInput.focus();

        editIndicator.style.display = 'block';
        sendBtn.textContent = 'Сохранить';
        sendBtn.classList.remove('btn-primary');
        sendBtn.classList.add('btn-warning');
    }

    // Отмена режима редактирования
    function cancelEditing(e) {
        if(e) e.preventDefault();

        editingMessageId = null;
        messageInput.value = '';

        editIndicator.style.display = 'none';
        sendBtn.textContent = 'Отправить';
        sendBtn.classList.add('btn-primary');
        sendBtn.classList.remove('btn-warning');
    }

    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        // Отмена редактирования по Esc
        if (e.key === 'Escape' && editingMessageId) {
            cancelEditing();
        }
    });

    function appendMessage(data) {
        const isMine = data.sender_id === currentUserId;
        const div = document.createElement('div');
        div.className = `message ${isMine ? 'mine' : 'theirs'}`;
        div.id = `msg-${data.message_id}`;

        const senderLine = isMine ? '' : `<div class="message-sender">${data.sender_name}</div>`;
        const editedText = data.is_edited ? '<span class="edited-label">(изменено)</span>' : '';

        // Кнопки действий (только для своих сообщений)
        let actionsHtml = '';
        if (isMine) {
            // Экранирование кавычек для JS вызова
            const safeContent = data.content.replace(/"/g, '&quot;');
            actionsHtml = `
                <div class="message-actions">
                    <div class="action-btn edit" onclick='startEditing(${data.message_id}, "${safeContent}")' title="Редактировать">✎</div>
                    <div class="action-btn delete" onclick="deleteMessage(${data.message_id})" title="Удалить">&times;</div>
                </div>
            `;
        }

        div.innerHTML = `
            ${actionsHtml}
            ${senderLine}
            <span class="message-content">${data.content}</span>
            ${editedText}
            <span class="message-time text-end">${data.created_at}</span>
        `;

        messagesBox.appendChild(div);
        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function deleteMessage(messageId) {
        if (confirm('Вы действительно хотите удалить это сообщение?')) {
            // Если удаляем сообщение, которое сейчас редактируем, сбрасываем режим
            if (editingMessageId === messageId) cancelEditing();

            socket.emit('delete_message', {
                message_id: messageId,
                conversation_id: currentConversationId
            });
        }
    }

    function searchUsers() {
        const query = document.getElementById('user-search-input').value.trim();
        const resultsDiv = document.getElementById('user-search-results');

        if (query.length < 2) {
            resultsDiv.innerHTML = '<p class="text-muted p-2">Введите не менее двух символов.</p>';
            return;
        }

        resultsDiv.innerHTML = '<p class="text-center p-2 text-muted">Поиск...</p>';

        fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
                resultsDiv.innerHTML = '';
                if (users.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-center p-2 text-muted">Пользователи не найдены.</p>';
                    return;
                }
                users.forEach(user => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action user-search-item';
                    item.innerHTML = `<strong>${user.username}</strong><small class="text-muted d-block">${user.email}</small>`;
                    item.onclick = (e) => {
                        e.preventDefault();
                        selectUserForChat(user.id, user.username);
                    };
                    resultsDiv.appendChild(item);
                });
            })
            .catch(error => {
                resultsDiv.innerHTML = `<p class="text-center p-2 text-danger">Ошибка поиска: ${error.message}</p>`;
            });
    }

    function selectUserForChat(userId, username) {
        targetUserId = userId;
        targetUsername = username;
        document.getElementById('selected-username').textContent = username;
        document.getElementById('selected-user-info').style.display = 'block';
        document.getElementById('create-chat-btn').disabled = false;
        document.getElementById('user-search-results').innerHTML = '';
        document.getElementById('user-search-input').value = username;
    }

    function createNewPrivateChat() {
        if (!targetUserId) return;
        const createButton = document.getElementById('create-chat-btn');
        createButton.disabled = true;

        fetch('/api/conversation/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({participant_ids: [targetUserId], type: 'private'})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`Ошибка: ${data.error}`);
                createButton.disabled = false;
                return;
            }
            const newConvoId = data.conversation_id;
            const newConvoElement = document.createElement('div');
            newConvoElement.id = `convo-${newConvoId}`;
            newConvoElement.className = 'chat-item';
            newConvoElement.setAttribute('onclick', `selectChat(${newConvoId}, this)`);
            newConvoElement.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Чат с ${targetUsername}</h6>
                    <small class="text-muted">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</small>
                </div>
                <p class="mb-1 small text-muted text-truncate">Начните общение...</p>
            `;
            chatList.prepend(newConvoElement);
            newChatModal.hide();
            selectChat(newConvoId, newConvoElement);
        })
        .catch(error => {
            alert('Произошла ошибка при создании чата.');
            createButton.disabled = false;
        });
    }

    messagesBox.scrollTop = messagesBox.scrollHeight;
</script>

</body>
</html>